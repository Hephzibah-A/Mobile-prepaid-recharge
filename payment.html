<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MobiComm | Payment</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="Assets/css/payment.css">
    <link rel="icon" href="Assets/png/favicon.ico">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Bootstrap CSS for responsiveness -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .btn-primary {
            background-color: #4B0082;
            /* Dark Purple */
            border-color: #4B0082;
        }

        .btn-primary:hover {
            background-color: #3A0068;
            /* Darker Purple */
            border-color: #3A0068;
        }
    </style>
</head>

<body>
    <header>
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand" href="main.html">
                    <img src="Assets/png/logo_color.png" alt="MobiComm Logo" style="height: 50px;">
                </a>
            </div>
        </nav>
    </header>
    <main class="container mt-4">
        <div class="row">
            <!-- Recharge Summary Section -->
            <div class="col-md-3">
                <div class="plan-summary">
                    <h2>Recharge Summary</h2>
                    <div id="planDetails"></div>
                    <a href="plans.html"><button class="btn btn-primary" id="editPlanButton">Edit Plan</button></a>
                </div>
            </div>
            <!-- Payment Methods Section -->
            <div class="col-md-5">
                <div class="plan-summary">
                    <h2>Payment Methods</h2>
                    <div class="payment-methods">
                        <label>
                            <input type="radio" name="paymentMethod" value="upi" id="upi-radio"> UPI (Google Pay etc...)
                        </label><br>
                        <label>
                            <input type="radio" name="paymentMethod" value="card" id="card-radio" checked> Credit /
                            Debit card
                        </label><br>
                        <label>
                            <input type="radio" name="paymentMethod" value="netbanking" id="netbanking-radio"> Net
                            Banking
                        </label><br>
                        <label>
                            <input type="radio" name="paymentMethod" value="wallet" id="wallet-radio"> Wallet (Paytm,
                            etc...)
                        </label>
                    </div>

                    <!-- Card Payment Form -->
                    <div id="card-form" class="payment-form">
                        <div class="card-details">
                            <label for="cardNumber">Card number</label>
                            <input type="text" id="cardNumber" placeholder="0000 0000 0000 0000">
                            <span id="cardNumberError" class="error-message text-danger"></span><br>

                            <label for="expiry">Expires</label>
                            <input type="text" id="expiry" placeholder="MM / YY">
                            <span id="expiryError" class="error-message text-danger"></span><br>

                            <label for="cvc">Security code</label>
                            <input type="text" id="cvc" placeholder="CVC">
                            <span id="cvcError" class="error-message text-danger"></span><br>

                            <label for="cardholder">Cardholder name</label>
                            <input type="text" id="cardholder" placeholder="Amy Schumer">
                            <span id="cardholderError" class="error-message text-danger"></span><br>

                            <button class="btn btn-primary" id="cardPayBtn">Pay ₹<span id="paymentAmount"></span>
                                now</button>
                            <div class="secure-payment">Your transaction is secured with SSL encryption</div>
                        </div>
                    </div>

                    <!-- UPI Payment Form -->
                    <div id="upi-form" class="payment-form">
                        <div class="card-details">
                            <label for="upiId">UPI ID</label>
                            <input type="text" id="upiId" placeholder="your_upi_id@bank">
                            <span id="upiIdError" class="error-message text-danger"></span><br>

                            <button class="btn btn-primary" id="upiPayBtn">Pay ₹<span id="paymentAmountUpi"></span>
                                now</button>
                            <div class="secure-payment">Your transaction is secured with SSL encryption</div>
                        </div>
                    </div>

                    <!-- NetBanking Payment Form -->
                    <div id="netbanking-form" class="payment-form">
                        <div class="card-details">
                            <label for="bankName">Bank Name</label>
                            <input type="text" id="bankName" placeholder="Your Bank Name">
                            <span id="bankNameError" class="error-message text-danger"></span><br>

                            <label for="netbankingId">NetBanking ID</label>
                            <input type="text" id="netbankingId" placeholder="Your NetBanking ID">
                            <span id="netbankingIdError" class="error-message text-danger"></span><br>

                            <label for="netbankingPassword">Password</label>
                            <input type="password" id="netbankingPassword" placeholder="Your Password">
                            <span id="netbankingPasswordError" class="error-message text-danger"></span><br>

                            <button class="btn btn-primary" id="netbankingPayBtn">Pay ₹<span
                                    id="paymentAmountNetbanking"></span> now</button>
                            <div class="secure-payment">Your transaction is secured with SSL encryption</div>
                        </div>
                    </div>

                    <!-- Wallet Payment Form -->
                    <div id="wallet-form" class="payment-form">
                        <div class="card-details">
                            <label for="walletProvider">Wallet Provider</label>
                            <input type="text" id="walletProvider" placeholder="Paytm/PhonePe/etc.">
                            <span id="walletProviderError" class="error-message text-danger"></span><br>

                            <label for="walletMobile">Mobile Number</label>
                            <input type="text" id="walletMobile" placeholder="Your Mobile Number">
                            <span id="walletMobileError" class="error-message text-danger"></span><br>

                            <button class="btn btn-primary" id="walletPayBtn">Pay ₹<span
                                    id="paymentAmountWallet"></span> now</button>
                            <div class="secure-payment">Your transaction is secured with SSL encryption</div>
                        </div>
                    </div>

                </div>
            </div>
            <div class="col-md-4 payment-image">
                <img src="Assets/png/Mobile payments-rafiki 1.png" alt="Payment Illustration" class="img-fluid">
            </div>
        </div>
    </main>
    <br><br>
    <footer>
        <div class="container-fluid">
            <div class="row">
                <div class="col-md-3">
                    <a class="navbar-brand" href="#">
                        <img src="Assets/png/logo.png" alt="MobiComm Logo">
                    </a>
                </div>
                <div class="col-md-9">
                    <div class="footer-links">
                        <p>&copy;2025 Company Name. All rights reserved.
                            <a href="#">Privacy &amp; Policy</a> |
                            <a href="#">Terms &amp; Condition</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </footer>
    <script src="Assets/js/script.js"></script>
    <!-- Bootstrap JS for responsiveness and interactive components -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Inline Payment JS Code -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Retrieve the selected plan from localStorage
            const selectedPlan = JSON.parse(localStorage.getItem('selectedPlan'));
            const planDetails = document.getElementById('planDetails');
            const paymentAmount = document.getElementById('paymentAmount');
            const paymentAmountUpi = document.getElementById('paymentAmountUpi');
            const paymentAmountNetbanking = document.getElementById('paymentAmountNetbanking');
            const paymentAmountWallet = document.getElementById('paymentAmountWallet');

            // Payment forms and radio buttons
            const cardForm = document.getElementById('card-form');
            const upiForm = document.getElementById('upi-form');
            const netbankingForm = document.getElementById('netbanking-form');
            const walletForm = document.getElementById('wallet-form');
            const upiRadio = document.getElementById('upi-radio');
            const cardRadio = document.getElementById('card-radio');
            const netbankingRadio = document.getElementById('netbanking-radio');
            const walletRadio = document.getElementById('wallet-radio');
            const editPlanButton = document.getElementById('editPlanButton');

            // Display the selected plan details and set payment amounts
            if (selectedPlan) {
                planDetails.innerHTML = `
              <ul>
                  <li><strong>Plan Name:</strong> ${selectedPlan.name ? selectedPlan.name : "Plan " + selectedPlan.id}</li>
                  <li><strong>Price:</strong> ₹${selectedPlan.price}</li>
                  <li><strong>Data:</strong> ${selectedPlan.data}</li>
                  <li><strong>Calls:</strong> ${selectedPlan.calls}</li>
                  <li><strong>Validity:</strong> ${selectedPlan.validity} Days</li>
              </ul>
          `;
                paymentAmount.textContent = selectedPlan.price;
                paymentAmountUpi.textContent = selectedPlan.price;
                paymentAmountNetbanking.textContent = selectedPlan.price;
                paymentAmountWallet.textContent = selectedPlan.price;
            } else {
                planDetails.innerHTML = `<p class="text-muted">No plan selected.</p>`;
            }

            editPlanButton.addEventListener('click', () => {
                window.location.href = 'plans.html';
            });

            // Utility function: Hide all payment forms
            function hideAllForms() {
                cardForm.style.display = 'none';
                upiForm.style.display = 'none';
                netbankingForm.style.display = 'none';
                walletForm.style.display = 'none';
            }

            // Event listeners for radio buttons to toggle forms
            upiRadio.addEventListener('change', () => {
                hideAllForms();
                upiForm.style.display = 'block';
                localStorage.setItem("selectedPaymentMethod", "UPI");
            });
            cardRadio.addEventListener('change', () => {
                hideAllForms();
                cardForm.style.display = 'block';
                localStorage.setItem("selectedPaymentMethod", "Debit/Credit Card");
            });
            netbankingRadio.addEventListener('change', () => {
                hideAllForms();
                netbankingForm.style.display = 'block';
                localStorage.setItem("selectedPaymentMethod", "Net Banking");
            });
            walletRadio.addEventListener('change', () => {
                hideAllForms();
                walletForm.style.display = 'block';
                localStorage.setItem("selectedPaymentMethod", "Wallet");
            });

            // Show Card form by default
            hideAllForms();
            cardForm.style.display = 'block';

            // ======================================================
            // Validation Functions Using <span> Elements for Error Messages
            // ======================================================

            function validateCardForm() {
                const cardNumber = document.getElementById('cardNumber').value;
                const expiry = document.getElementById('expiry').value;
                const cvc = document.getElementById('cvc').value;
                const cardholder = document.getElementById('cardholder').value;

                const cardNumberError = document.getElementById('cardNumberError');
                const expiryError = document.getElementById('expiryError');
                const cvcError = document.getElementById('cvcError');
                const cardholderError = document.getElementById('cardholderError');

                // Reset error messages
                cardNumberError.textContent = '';
                expiryError.textContent = '';
                cvcError.textContent = '';
                cardholderError.textContent = '';

                let isValid = true;

                // Validate card number: remove spaces and check for 16 digits
                const sanitizedCardNumber = cardNumber.replace(/\s+/g, '');
                if (!/^\d{16}$/.test(sanitizedCardNumber)) {
                    cardNumberError.textContent = 'Please enter a valid 16-digit card number.';
                    isValid = false;
                }

                // Validate expiry date (MM/YY)
                if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiry.trim())) {
                    expiryError.textContent = 'Please enter a valid expiry date in MM/YY format.';
                    isValid = false;
                }

                // Validate CVC: exactly 3 digits
                if (!/^\d{3}$/.test(cvc.trim())) {
                    cvcError.textContent = 'Please enter a valid 3-digit CVC.';
                    isValid = false;
                }

                // Validate cardholder name: only letters and spaces
                if (!/^[a-zA-Z\s]+$/.test(cardholder.trim())) {
                    cardholderError.textContent = 'Please enter a valid cardholder name.';
                    isValid = false;
                }
                return isValid;
            }

            function validateUpiForm() {
                const upiId = document.getElementById('upiId').value;
                const upiIdError = document.getElementById('upiIdError');
                upiIdError.textContent = '';
                let isValid = true;
                if (!/^[\w.-]+@[\w.-]+$/.test(upiId.trim())) {
                    upiIdError.textContent = 'Please enter a valid UPI ID.';
                    isValid = false;
                }
                return isValid;
            }

            function validateNetbankingForm() {
                const bankName = document.getElementById('bankName').value;
                const netbankingId = document.getElementById('netbankingId').value;
                const netbankingPassword = document.getElementById('netbankingPassword').value;

                const bankNameError = document.getElementById('bankNameError');
                const netbankingIdError = document.getElementById('netbankingIdError');
                const netbankingPasswordError = document.getElementById('netbankingPasswordError');

                bankNameError.textContent = '';
                netbankingIdError.textContent = '';
                netbankingPasswordError.textContent = '';

                let isValid = true;
                if (bankName.trim() === '') {
                    bankNameError.textContent = 'Bank Name is required.';
                    isValid = false;
                }
                if (netbankingId.trim() === '') {
                    netbankingIdError.textContent = 'NetBanking ID is required.';
                    isValid = false;
                }
                if (netbankingPassword.trim() === '') {
                    netbankingPasswordError.textContent = 'Password is required.';
                    isValid = false;
                }
                return isValid;
            }

            function validateWalletForm() {
                const walletProvider = document.getElementById('walletProvider').value;
                const walletMobile = document.getElementById('walletMobile').value;
                const walletProviderError = document.getElementById('walletProviderError');
                const walletMobileError = document.getElementById('walletMobileError');

                walletProviderError.textContent = '';
                walletMobileError.textContent = '';

                let isValid = true;
                if (walletProvider.trim() === '') {
                    walletProviderError.textContent = 'Wallet Provider is required.';
                    isValid = false;
                }
                if (!/^\d{10}$/.test(walletMobile.trim())) {
                    walletMobileError.textContent = 'Please enter a valid 10-digit mobile number.';
                    isValid = false;
                }
                return isValid;
            }

            // ======================================================
            // Record Payment and Update the User's Payment History via JSON Server
            // ======================================================
            function recordPayment(paymentMethod) {
                // Get the mobile number from localStorage (assumed stored under 'mobileNumber')
                const mobileNumber = localStorage.getItem('mobileNumber');
                if (!mobileNumber) {
                    console.error("Mobile number not found in localStorage.");
                    return;
                }
                // Create a new payment record
                const currentDate = new Date().toISOString().slice(0, 10); // Format: YYYY-MM-DD
                const newPayment = {
                    id: Date.now(), // using timestamp as unique ID
                    date: currentDate,
                    amount: selectedPlan ? selectedPlan.price : 0,
                    method: paymentMethod
                };

                // Fetch the user record from JSON Server using the mobile number (assuming field 'phnno')
                fetch('http://localhost:3000/users?phnno=' + mobileNumber)
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("HTTP error " + response.status);
                        }
                        return response.json();
                    })
                    .then(users => {
                        if (users.length === 0) {
                            console.error("User not found for mobile number: " + mobileNumber);
                            return;
                        }
                        let user = users[0];
                        // Ensure user.paymentHistory is an array
                        if (!Array.isArray(user.paymentHistory)) {
                            user.paymentHistory = [];
                        }
                        // Append the new payment record
                        user.paymentHistory.push(newPayment);

                        // Update the user record on JSON Server via PUT request
                        fetch('http://localhost:3000/users/' + user.id, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(user)
                        })
                            .then(updateResponse => {
                                if (!updateResponse.ok) {
                                    throw new Error("HTTP error " + updateResponse.status);
                                }
                                return updateResponse.json();
                            })
                            .then(updatedUser => {
                                console.log("Payment recorded successfully for user:", updatedUser);
                                // After successful update, redirect to success page
                                window.location.href = "success.html";
                            })
                            .catch(error => {
                                console.error("Error updating user's payment history:", error);
                            });
                    })
                    .catch(error => {
                        console.error("Error fetching user record:", error);
                    });
            }

            // ======================================================
            // Attach Event Listeners to Payment Method Buttons
            // ======================================================

            // Card Payment Button
            document.getElementById('cardPayBtn').addEventListener('click', function (event) {
                event.preventDefault();
                if (validateCardForm()) {
                    alert("Card payment successful (placeholder)");
                    recordPayment("card");
                }
            });

            // UPI Payment Button
            document.getElementById('upiPayBtn').addEventListener('click', function (event) {
                event.preventDefault();
                if (validateUpiForm()) {
                    alert("UPI payment successful (placeholder)");
                    recordPayment("upi");
                }
            });

            // NetBanking Payment Button
            document.getElementById('netbankingPayBtn').addEventListener('click', function (event) {
                event.preventDefault();
                if (validateNetbankingForm()) {
                    alert("Netbanking payment successful (placeholder)");
                    recordPayment("netbanking");
                }
            });

            // Wallet Payment Button
            document.getElementById('walletPayBtn').addEventListener('click', function (event) {
                event.preventDefault();
                if (validateWalletForm()) {
                    alert("Wallet payment successful (placeholder)");
                    recordPayment("wallet");
                }
            });
        });
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>

</html>