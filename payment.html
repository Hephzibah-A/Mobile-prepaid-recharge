<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MobiComm | Payment</title>
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="css/styles.css" />
    <link rel="stylesheet" href="Assets/css/payment.css" />
    <link rel="icon" href="Assets/png/favicon.ico" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
        integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
    <style>
        /* Define theme variables */
        :root {
            --text: rgb(6, 6, 4);
            --background: rgb(251, 251, 249);
            --primary: rgb(63, 0, 163);
            --secondary: rgb(68, 0, 179);
            --accent: rgb(255, 157, 0);
        }

        /* Global Styles */
        body {
            background-color: var(--background);
            color: var(--text);
            font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
            margin: 0;
            padding: 0;
        }

        a {
            color: var(--primary);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }

        h2 {
            color: var(--primary);
            margin-bottom: 1rem;
        }

        /* Header / Navbar */
        header,
        .navbar {
            background-color: var(--background);
            border-bottom: 1px solid #e0e0e0;
        }

        .navbar-brand img {
            max-height: 50px;
        }

        /* Main Payment Container */
        main.container {
            background: #fff;
            padding: 2rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            margin-top: 2rem;
        }

        .plan-summary {
            background: var(--background);
            padding: 1.5rem;
            border-radius: 8px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 1.5rem;
        }

        .plan-summary h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--primary);
        }

        .plan-summary ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .plan-summary ul li {
            margin-bottom: 0.5rem;
        }

        /* Highlight the Price with Accent */
        .plan-summary ul li strong {
            color: var(--secondary);
        }

        .plan-summary ul li .price-amount {
            color: var(--accent);
            font-weight: 600;
        }

        /* Edit Plan button using accent color */
        #editPlanButton {
            background-color: var(--accent);
            border-color: var(--accent);
            border-radius: 50px;
            padding: 0.6rem 1.2rem;
        }

        #editPlanButton:hover {
            opacity: 0.9;
        }

        /* Payment Methods */
        .payment-methods label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: var(--text);
        }

        /* Payment Form Styles */
        .payment-form {
            margin-top: 1rem;
        }

        .card-details label {
            font-size: 0.9rem;
            color: var(--secondary);
        }

        .card-details input {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.25rem;
            margin-bottom: 0.5rem;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 0.95rem;
        }

        .card-details .error-message {
            font-size: 0.85rem;
        }

        .btn-primary {
            background-color: var(--primary);
            border-color: var(--primary);
            font-weight: 600;
            padding: 0.6rem 1.2rem;
            border-radius: 50px;
        }

        .btn-primary:hover {
            background-color: var(--secondary);
            border-color: var(--secondary);
        }

        .btn-accent {
            color: white;
            background-color: var(--accent);
            border-color: var(--accent);
            border-radius: 50px;
            padding: 0.6rem 1.2rem;
        }

        .btn-accent:hover {
            background-color: rgb(204, 126, 0);
            border-color: rgb(204, 126, 0);
        }

        .secure-payment {
            font-size: 0.8rem;
            color: var(--accent);
            margin-top: 0.5rem;
        }

        /* Payment Image */
        .payment-image img {
            max-width: 100%;
        }

        /* Footer Styles */
        footer {
            background: var(--background);
            border-top: 1px solid #e0e0e0;
            padding: 1rem 0;
            margin-top: 2rem;
            font-size: 0.9rem;
        }

        .footer-links p {
            margin: 0;
            color: var(--text);
        }

        .footer-links a {
            color: var(--primary);
        }

        /* Custom Success Toast (Success Card) */
        .toast-card {
            width: 330px;
            height: 80px;
            border-radius: 8px;
            padding: 10px 15px;
            background-color: var(--background);
            box-shadow: rgba(149, 157, 165, 0.2) 0px 8px 24px;
            position: fixed;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1050;
        }

        .toast-card .wave {
            position: absolute;
            transform: rotate(90deg);
            left: -31px;
            top: 32px;
            width: 80px;
            fill: rgba(63, 0, 163, 0.23);
        }

        .toast-card .icon-container {
            width: 35px;
            height: 35px;
            display: flex;
            justify-content: center;
            align-items: center;
            background-color: rgba(63, 0, 163, 0.3);
            border-radius: 50%;
            margin-left: 8px;
        }

        .toast-card .icon {
            width: 17px;
            height: 17px;
            color: var(--accent);
        }

        .toast-card .message-text-container {
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: flex-start;
            flex-grow: 1;
        }

        .toast-card .message-text {
            color: var(--primary);
            font-size: 17px;
            font-weight: 700;
            margin: 0;
        }

        .toast-card .sub-text {
            font-size: 14px;
            color: var(--secondary);
            margin: 0;
        }

        .toast-card .cross-icon {
            width: 18px;
            height: 18px;
            color: var(--text);
            cursor: pointer;
        }
    </style>
</head>

<body>
    <!-- Header / Navbar -->
    <header>
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand" href="main.html">
                    <img src="Assets/png/logo_color.png" alt="MobiComm Logo">
                </a>
            </div>
        </nav>
    </header>

    <!-- Main Payment Section -->
    <main class="container mt-4">
        <div class="row">
            <!-- Recharge Summary Section -->
            <div class="col-md-3">
                <div class="plan-summary">
                    <h2>Recharge Summary</h2>
                    <div id="planDetails"></div>
                    <a href="plans.html"><button class="btn btn-accent" id="editPlanButton">Edit Plan</button></a>
                </div>
            </div>
            <!-- Payment Methods Section -->
            <div class="col-md-5">
                <div class="plan-summary">
                    <h2>Payment Methods</h2>
                    <div class="payment-methods">
                        <label>
                            <input type="radio" name="paymentMethod" value="upi" id="upi-radio"> UPI (Google Pay etc...)
                        </label><br>
                        <label>
                            <input type="radio" name="paymentMethod" value="card" id="card-radio" checked> Credit /
                            Debit card
                        </label><br>
                        <label>
                            <input type="radio" name="paymentMethod" value="netbanking" id="netbanking-radio"> Net
                            Banking
                        </label><br>
                        <label>
                            <input type="radio" name="paymentMethod" value="wallet" id="wallet-radio"> Wallet (Paytm,
                            etc...)
                        </label>
                    </div>

                    <!-- Card Payment Form -->
                    <div id="card-form" class="payment-form">
                        <div class="card-details">
                            <label for="cardNumber">Card number</label>
                            <input type="text" id="cardNumber" placeholder="0000 0000 0000 0000">
                            <span id="cardNumberError" class="error-message text-danger"></span><br>

                            <label for="expiry">Expires</label>
                            <input type="text" id="expiry" placeholder="MM / YY">
                            <span id="expiryError" class="error-message text-danger"></span><br>

                            <label for="cvc">Security code</label>
                            <input type="text" id="cvc" placeholder="CVC">
                            <span id="cvcError" class="error-message text-danger"></span><br>

                            <label for="cardholder">Cardholder name</label>
                            <input type="text" id="cardholder" placeholder="Amy Schumer">
                            <span id="cardholderError" class="error-message text-danger"></span><br>

                            <button class="btn btn-primary" id="cardPayBtn">Pay ₹<span id="paymentAmount"></span>
                                now</button>
                            <div class="secure-payment">Your transaction is secured with SSL encryption</div>
                        </div>
                    </div>

                    <!-- UPI Payment Form -->
                    <div id="upi-form" class="payment-form">
                        <div class="card-details">
                            <label for="upiId">UPI ID</label>
                            <input type="text" id="upiId" placeholder="your_upi_id@bank">
                            <span id="upiIdError" class="error-message text-danger"></span><br>

                            <button class="btn btn-primary" id="upiPayBtn">Pay ₹<span id="paymentAmountUpi"></span>
                                now</button>
                            <div class="secure-payment">Your transaction is secured with SSL encryption</div>
                        </div>
                    </div>

                    <!-- NetBanking Payment Form -->
                    <div id="netbanking-form" class="payment-form">
                        <div class="card-details">
                            <label for="bankName">Bank Name</label>
                            <input type="text" id="bankName" placeholder="Your Bank Name">
                            <span id="bankNameError" class="error-message text-danger"></span><br>

                            <label for="netbankingId">NetBanking ID</label>
                            <input type="text" id="netbankingId" placeholder="Your NetBanking ID">
                            <span id="netbankingIdError" class="error-message text-danger"></span><br>

                            <label for="netbankingPassword">Password</label>
                            <input type="password" id="netbankingPassword" placeholder="Your Password">
                            <span id="netbankingPasswordError" class="error-message text-danger"></span><br>

                            <button class="btn btn-primary" id="netbankingPayBtn">Pay ₹<span
                                    id="paymentAmountNetbanking"></span> now</button>
                            <div class="secure-payment">Your transaction is secured with SSL encryption</div>
                        </div>
                    </div>

                    <!-- Wallet Payment Form -->
                    <div id="wallet-form" class="payment-form">
                        <div class="card-details">
                            <label for="walletProvider">Wallet Provider</label>
                            <input type="text" id="walletProvider" placeholder="Paytm/PhonePe/etc.">
                            <span id="walletProviderError" class="error-message text-danger"></span><br>

                            <label for="walletMobile">Mobile Number</label>
                            <input type="text" id="walletMobile" placeholder="Your Mobile Number">
                            <span id="walletMobileError" class="error-message text-danger"></span><br>

                            <button class="btn btn-primary" id="walletPayBtn">Pay ₹<span
                                    id="paymentAmountWallet"></span> now</button>
                            <div class="secure-payment">Your transaction is secured with SSL encryption</div>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Payment Image Section -->
            <div class="col-md-4 payment-image">
                <img src="Assets/png/Mobile payments-rafiki 1.png" alt="Payment Illustration" class="img-fluid">
            </div>
        </div>
    </main>

    <br><br>

    <!-- Footer -->
    <footer>
        <div class="container-fluid">
            <div class="row align-items-center">
                <div class="col-md-3">
                    <a class="navbar-brand" href="#">
                        <img src="Assets/png/logo.png" alt="MobiComm Logo">
                    </a>
                </div>
                <div class="col-md-9">
                    <div class="footer-links">
                        <p>&copy;2025 Company Name. All rights reserved.
                            <a href="#">Privacy &amp; Policy</a> |
                            <a href="#">Terms &amp; Condition</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </footer>

    <!-- External JS -->
    <script src="Assets/js/script.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <!-- Inline Payment JS Code -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            // Retrieve the selected plan from localStorage
            const selectedPlan = JSON.parse(localStorage.getItem('selectedPlan'));
            const planDetails = document.getElementById('planDetails');
            const paymentAmount = document.getElementById('paymentAmount');
            const paymentAmountUpi = document.getElementById('paymentAmountUpi');
            const paymentAmountNetbanking = document.getElementById('paymentAmountNetbanking');
            const paymentAmountWallet = document.getElementById('paymentAmountWallet');

            // Payment forms and radio buttons
            const cardForm = document.getElementById('card-form');
            const upiForm = document.getElementById('upi-form');
            const netbankingForm = document.getElementById('netbanking-form');
            const walletForm = document.getElementById('wallet-form');
            const upiRadio = document.getElementById('upi-radio');
            const cardRadio = document.getElementById('card-radio');
            const netbankingRadio = document.getElementById('netbanking-radio');
            const walletRadio = document.getElementById('wallet-radio');
            const editPlanButton = document.getElementById('editPlanButton');

            // Display the selected plan details and set payment amounts
            if (selectedPlan) {
                planDetails.innerHTML = `
              <ul>
                  <li><strong>Plan Name:</strong> ${selectedPlan.name ? selectedPlan.name : "Plan " + selectedPlan.id}</li>
                  <li><strong>Price:</strong> <span class="price-amount">₹${selectedPlan.price}</span></li>
                  <li><strong>Data:</strong> ${selectedPlan.data}</li>
                  <li><strong>Calls:</strong> ${selectedPlan.calls}</li>
                  <li><strong>Validity:</strong> ${selectedPlan.validity} Days</li>
              </ul>
          `;
                paymentAmount.textContent = selectedPlan.price;
                paymentAmountUpi.textContent = selectedPlan.price;
                paymentAmountNetbanking.textContent = selectedPlan.price;
                paymentAmountWallet.textContent = selectedPlan.price;
            } else {
                planDetails.innerHTML = `<p class="text-muted">No plan selected.</p>`;
            }

            editPlanButton.addEventListener('click', () => {
                window.location.href = 'plans.html';
            });

            // Utility function: Hide all payment forms
            function hideAllForms() {
                cardForm.style.display = 'none';
                upiForm.style.display = 'none';
                netbankingForm.style.display = 'none';
                walletForm.style.display = 'none';
            }

            // Event listeners for radio buttons to toggle forms
            upiRadio.addEventListener('change', () => {
                hideAllForms();
                upiForm.style.display = 'block';
                localStorage.setItem("selectedPaymentMethod", "UPI");
            });
            cardRadio.addEventListener('change', () => {
                hideAllForms();
                cardForm.style.display = 'block';
                localStorage.setItem("selectedPaymentMethod", "Debit/Credit Card");
            });
            netbankingRadio.addEventListener('change', () => {
                hideAllForms();
                netbankingForm.style.display = 'block';
                localStorage.setItem("selectedPaymentMethod", "Net Banking");
            });
            walletRadio.addEventListener('change', () => {
                hideAllForms();
                walletForm.style.display = 'block';
                localStorage.setItem("selectedPaymentMethod", "Wallet");
            });

            // Show Card form by default
            hideAllForms();
            cardForm.style.display = 'block';

            function validateCardForm() {
                const cardNumber = document.getElementById('cardNumber').value;
                const expiry = document.getElementById('expiry').value;
                const cvc = document.getElementById('cvc').value;
                const cardholder = document.getElementById('cardholder').value;

                const cardNumberError = document.getElementById('cardNumberError');
                const expiryError = document.getElementById('expiryError');
                const cvcError = document.getElementById('cvcError');
                const cardholderError = document.getElementById('cardholderError');

                // Reset error messages
                cardNumberError.textContent = '';
                expiryError.textContent = '';
                cvcError.textContent = '';
                cardholderError.textContent = '';

                let isValid = true;

                // Validate card number: remove spaces and check for 16 digits
                const sanitizedCardNumber = cardNumber.replace(/\s+/g, '');
                if (!/^\d{16}$/.test(sanitizedCardNumber)) {
                    cardNumberError.textContent = 'Please enter a valid 16-digit card number.';
                    isValid = false;
                }

                // Validate expiry date (MM/YY)
                if (!/^(0[1-9]|1[0-2])\/\d{2}$/.test(expiry.trim())) {
                    expiryError.textContent = 'Please enter a valid expiry date in MM/YY format.';
                    isValid = false;
                }

                // Validate CVC: exactly 3 digits
                if (!/^\d{3}$/.test(cvc.trim())) {
                    cvcError.textContent = 'Please enter a valid 3-digit CVC.';
                    isValid = false;
                }

                // Validate cardholder name: only letters and spaces
                if (!/^[a-zA-Z\s]+$/.test(cardholder.trim())) {
                    cardholderError.textContent = 'Please enter a valid cardholder name.';
                    isValid = false;
                }
                return isValid;
            }

            function validateUpiForm() {
                const upiId = document.getElementById('upiId').value;
                const upiIdError = document.getElementById('upiIdError');
                upiIdError.textContent = '';
                let isValid = true;
                if (!/^[\w.-]+@[\w.-]+$/.test(upiId.trim())) {
                    upiIdError.textContent = 'Please enter a valid UPI ID.';
                    isValid = false;
                }
                return isValid;
            }

            function validateNetbankingForm() {
                const bankName = document.getElementById('bankName').value;
                const netbankingId = document.getElementById('netbankingId').value;
                const netbankingPassword = document.getElementById('netbankingPassword').value;

                const bankNameError = document.getElementById('bankNameError');
                const netbankingIdError = document.getElementById('netbankingIdError');
                const netbankingPasswordError = document.getElementById('netbankingPasswordError');

                bankNameError.textContent = '';
                netbankingIdError.textContent = '';
                netbankingPasswordError.textContent = '';

                let isValid = true;
                if (bankName.trim() === '') {
                    bankNameError.textContent = 'Bank Name is required.';
                    isValid = false;
                }
                if (netbankingId.trim() === '') {
                    netbankingIdError.textContent = 'NetBanking ID is required.';
                    isValid = false;
                }
                if (netbankingPassword.trim() === '') {
                    netbankingPasswordError.textContent = 'Password is required.';
                    isValid = false;
                }
                return isValid;
            }

            function validateWalletForm() {
                const walletProvider = document.getElementById('walletProvider').value;
                const walletMobile = document.getElementById('walletMobile').value;
                const walletProviderError = document.getElementById('walletProviderError');
                const walletMobileError = document.getElementById('walletMobileError');

                walletProviderError.textContent = '';
                walletMobileError.textContent = '';

                let isValid = true;
                if (walletProvider.trim() === '') {
                    walletProviderError.textContent = 'Wallet Provider is required.';
                    isValid = false;
                }
                if (!/^\d{10}$/.test(walletMobile.trim())) {
                    walletMobileError.textContent = 'Please enter a valid 10-digit mobile number.';
                    isValid = false;
                }
                return isValid;
            }

            function recordPayment(paymentMethod) {
                // Get the mobile number from localStorage (assumed stored under 'mobileNumber')
                const mobileNumber = localStorage.getItem('mobileNumber');
                if (!mobileNumber) {
                    console.error("Mobile number not found in localStorage.");
                    return;
                }
                // Create a new payment record
                const currentDate = new Date();
                const currentDateStr = currentDate.toISOString().slice(0, 10); // Format: YYYY-MM-DD
                const newPayment = {
                    id: Date.now(), // using timestamp as unique ID
                    date: currentDateStr,
                    amount: selectedPlan ? selectedPlan.price : 0,
                    method: paymentMethod
                };

                // Fetch the JSON data from /data/db.json
                fetch('/data/db.json')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error("HTTP error " + response.status);
                        }
                        return response.json();
                    })
                    .then(data => {
                        const users = data.users || [];
                        // Find the user record by matching mobile number
                        const matchingUsers = users.filter(user => user.phnno === mobileNumber);
                        if (matchingUsers.length === 0) {
                            console.error("User not found for mobile number: " + mobileNumber);
                            return;
                        }
                        let user = matchingUsers[0];
                        // Ensure user.paymentHistory is an array
                        if (!Array.isArray(user.paymentHistory)) {
                            user.paymentHistory = [];
                        }
                        // Append the new payment record
                        user.paymentHistory.push(newPayment);

                        // Calculate new plan expiry date:
                        // If the user has an existing expiry date that is in the future, extend from that.
                        // Otherwise, start from today.
                        let today = new Date(currentDateStr);
                        let baseDate = today;
                        if (user.planExpiryDate) {
                            let currentExpiry = new Date(user.planExpiryDate);
                            if (currentExpiry > today) {
                                baseDate = currentExpiry;
                            }
                        }
                        // Add validity days to baseDate (assuming selectedPlan.validity is a number or string convertible to a number)
                        let newExpiry = new Date(baseDate);
                        newExpiry.setDate(newExpiry.getDate() + parseInt(selectedPlan.validity, 10));
                        user.planExpiryDate = newExpiry.toISOString().slice(0, 10);

                        // Update the user record via PUT request
                        fetch('/data/db.json/users/' + user.id, {
                            method: 'PUT',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify(user)
                        })
                            .then(updateResponse => {
                                if (!updateResponse.ok) {
                                    throw new Error("HTTP error " + updateResponse.status);
                                }
                                return updateResponse.json();
                            })
                            .then(updatedUser => {
                                console.log("Payment recorded successfully for user:", updatedUser);
                                // After successful update, redirect to success page
                                window.location.href = "success.html";
                            })
                            .catch(error => {
                                console.error("Error updating user's payment history:", error);
                            });
                    })
                    .catch(error => {
                        console.error("Error fetching user record:", error);
                    });
            }

            // Card Payment Button
            document.getElementById('cardPayBtn').addEventListener('click', function (event) {
                event.preventDefault();
                if (validateCardForm()) {
                    alert("Card payment successful");
                    recordPayment("card");
                }
            });

            // UPI Payment Button
            document.getElementById('upiPayBtn').addEventListener('click', function (event) {
                event.preventDefault();
                if (validateUpiForm()) {
                    alert("UPI payment successful");
                    recordPayment("upi");
                }
            });

            // NetBanking Payment Button
            document.getElementById('netbankingPayBtn').addEventListener('click', function (event) {
                event.preventDefault();
                if (validateNetbankingForm()) {
                    alert("Netbanking payment successful");
                    recordPayment("netbanking");
                }
            });

            // Wallet Payment Button
            document.getElementById('walletPayBtn').addEventListener('click', function (event) {
                event.preventDefault();
                if (validateWalletForm()) {
                    alert("Wallet payment successful");
                    recordPayment("wallet");
                }
            });
        });

        // --- Custom Success Toast JavaScript ---
        function showSuccessToast() {
            const toast = document.getElementById("successToast");
            toast.style.display = "flex";
            setTimeout(function () {
                toast.style.display = "none";
            }, 3000);
        }

        document.querySelector("#successToast .cross-icon").addEventListener("click", function () {
            document.getElementById("successToast").style.display = "none";
        });
    </script>
</body>

</html>